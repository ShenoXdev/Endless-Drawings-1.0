<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Animation Engine</title>
<style>
  body { margin:0; font-family:sans-serif; background:#222; color:#fff; display:flex; height:100vh; }
  #toolbar { width:300px; padding:10px; background:#333; display:flex; flex-direction:column; gap:10px; overflow-y:auto; }
  button, input, select { padding:5px; font-size:14px; width:100%; }
  #canvas-container { flex:1; background:#111; display:flex; justify-content:center; align-items:center; overflow:hidden; position:relative; }
  canvas { background:#222; border:1px solid #555; cursor:crosshair; }
  #layers { max-height:200px; overflow-y:auto; background:#444; padding:5px; }
  .layer { padding:3px; border-bottom:1px solid #555; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div id="toolbar">
  <h3>Tools</h3>
  <button id="brush">Brush</button>
  <button id="line">Line</button>
  <button id="circle">Circle</button>
  <button id="eraser">Eraser</button>
  <button id="select">Select</button>

  <h3>Canvas</h3>
  <label>Width: <input type="number" id="canvasWidth" value="800"></label>
  <label>Height: <input type="number" id="canvasHeight" value="600"></label>
  <button id="resizeCanvas">Resize Canvas</button>
  <label>Zoom: <input type="range" id="zoom" min="0.5" max="3" step="0.1" value="1"></label>

  <h3>Animation</h3>
  <label>FPS: <input type="number" id="fps" value="24"></label>
  <button id="addLayer">Add Layer</button>
  <div id="layers"></div>

  <h3>Project</h3>
  <button id="saveJSON">Save JSON</button>
  <button id="loadJSON">Load JSON</button>
  <button id="exportMP4">Export MP4</button>
</div>

<div id="canvas-container">
  <canvas id="mainCanvas" width="800" height="600"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/whammy/0.2.0/whammy.js"></script>
<script>
// ====== Variables ======
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
let tool = 'brush';
let drawing = false;
let startX=0, startY=0;
let zoom = 1;
let layers = [];
let selectedLayer = null;
let fps = 24;
let objects = [];
let selectedObject = null;

// ====== Tool Buttons ======
document.getElementById('brush').onclick = () => tool='brush';
document.getElementById('line').onclick = () => tool='line';
document.getElementById('circle').onclick = () => tool='circle';
document.getElementById('eraser').onclick = () => tool='eraser';
document.getElementById('select').onclick = () => tool='select';

// ====== Canvas Zoom ======
document.getElementById('zoom').oninput = (e)=>{
  zoom = parseFloat(e.target.value);
  drawAll();
};

// ====== Resize Canvas ======
document.getElementById('resizeCanvas').onclick = ()=>{
  canvas.width = parseInt(document.getElementById('canvasWidth').value);
  canvas.height = parseInt(document.getElementById('canvasHeight').value);
  drawAll();
};

// ====== Add Layer ======
document.getElementById('addLayer').onclick = ()=>{
  const layer = {name:'Layer '+(layers.length+1), objects:[], visible:true};
  layers.push(layer);
  selectedLayer = layer;
  updateLayersUI();
};

// ====== Update Layers UI ======
function updateLayersUI(){
  const container = document.getElementById('layers');
  container.innerHTML='';
  layers.forEach((l,i)=>{
    const div = document.createElement('div');
    div.className='layer';
    div.innerHTML = `<span>${l.name}</span>
      <input type="checkbox" ${l.visible?'checked':''} onchange="layers[${i}].visible=this.checked;drawAll()">
    `;
    div.onclick = ()=>selectedLayer = l;
    container.appendChild(div);
  });
}

// ====== Canvas Drawing ======
canvas.onmousedown = (e)=>{
  const rect = canvas.getBoundingClientRect();
  startX = (e.clientX - rect.left)/zoom;
  startY = (e.clientY - rect.top)/zoom;
  drawing = true;
};

canvas.onmouseup = (e)=>{
  if(!drawing) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left)/zoom;
  const y = (e.clientY - rect.top)/zoom;
  if(selectedLayer){
    const obj = {tool, startX, startY, endX:x, endY:y, color:'#fff', size:2};
    selectedLayer.objects.push(obj);
    objects.push(obj);
  }
  drawing = false;
  drawAll();
};

canvas.onmousemove = (e)=>{
  if(!drawing) return;
  drawAll();
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left)/zoom;
  const y = (e.clientY - rect.top)/zoom;
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 2;
  ctx.beginPath();
  if(tool==='brush'){
    ctx.moveTo(startX,startY);
    ctx.lineTo(x,y);
    ctx.stroke();
    startX=x; startY=y;
  } else if(tool==='line'){
    ctx.moveTo(startX,startY);
    ctx.lineTo(x,y);
    ctx.stroke();
  } else if(tool==='circle'){
    const r=Math.hypot(x-startX,y-startY);
    ctx.arc(startX,startY,r,0,Math.PI*2);
    ctx.stroke();
  } else if(tool==='eraser'){
    ctx.clearRect(x-5,y-5,10,10);
  }
};

// ====== Draw All Layers ======
function drawAll(){
  ctx.setTransform(zoom,0,0,zoom,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  layers.forEach(layer=>{
    if(!layer.visible) return;
    layer.objects.forEach(o=>{
      ctx.strokeStyle = o.color;
      ctx.lineWidth = o.size;
      ctx.beginPath();
      if(o.tool==='brush'||o.tool==='line'){
        ctx.moveTo(o.startX,o.startY);
        ctx.lineTo(o.endX,o.endY);
        ctx.stroke();
      } else if(o.tool==='circle'){
        const r=Math.hypot(o.endX-o.startX,o.endY-o.startY);
        ctx.arc(o.startX,o.startY,r,0,Math.PI*2);
        ctx.stroke();
      }
    });
  });
}

// ====== FPS ======
document.getElementById('fps').oninput = (e)=>{ fps = parseInt(e.target.value); };

// ====== Save/Load JSON ======
document.getElementById('saveJSON').onclick = ()=>{
  const data = JSON.stringify(layers);
  const blob = new Blob([data],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='project.json';
  a.click();
};

document.getElementById('loadJSON').onclick = ()=>{
  const input = document.createElement('input');
  input.type='file';
  input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ()=>{
      layers = JSON.parse(reader.result);
      selectedLayer = layers[0]||null;
      updateLayersUI();
      drawAll();
    };
    reader.readAsText(file);
  };
  input.click();
};

// ====== Export MP4 (Whammy.js) ======
document.getElementById('exportMP4').onclick = ()=>{
  const encoder = new Whammy.Video(fps);
  layers.forEach(layer=>{
    layer.objects.forEach(o=>{
      drawAll();
      encoder.add(ctx);
    });
  });
  const output = encoder.compile();
  const url = URL.createObjectURL(output);
  const a = document.createElement('a');
  a.href=url; a.download='animation.mp4';
  a.click();
};

</script>
</body>
</html>
